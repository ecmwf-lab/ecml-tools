description: "develop version of the dataset for a few days and a few variables, once data on mars is cached it should take a few seconds to generate the dataset"
dataset_status: testing
purpose: aifs

name: test-small

remapping: &remapping
  #param_level: '{param}_{levtype}{levelist}'
  param_level: '{param}_{levelist}'

loop:
- dates:
    start: 2020-12-30 00:00:00
    end: 2021-01-03 12:00:00
    frequency: 12h
    group_by: monthly

input:
- dates:
    start: 2020-12-30 00:00:00
    end: 2021-01-03 12:00:00
    frequency: 12h
  join:
  - name: sfc_data
    remapping: *remapping
    kwargs:
      name: mars
      class: ea
      date: $datetime_format($dates,%Y%m%d)
      time: $datetime_format($dates,%H%M)
      #date: $datetime_format($dates,'2023%m%d')
      #hdate: $dates
      expver: '0001'
      grid: 20./20.
      levtype: sfc
      param: [2t]
      stream: oper
      type: an

  - name: acc_data
    inherit: sfc_data
    remapping: *remapping
    kwargs:
      name: era5-accumulations
      param: [cp, tp]
      # era5-accumulations requires time in hours
      time: $datetime_format($dates,%H)

  - name: pl_data
    inherit: sfc_data
    remapping: *remapping
    kwargs:
      name: mars
      levtype: pl
      param: [q, t]
      level: [50, 100]

  - name: forcings
    remapping: *remapping
    kwargs:
      name: constants
      param:
      - cos_latitude
      # date: $dates
      source_or_dataset: $previous


output:
  chunking:
    dates: 1
  dtype: float32
  flatten_grid: True
  order_by:
  - valid_datetime
  - param_level
  - number
  statistics: param_level
  statistics_end: 2021
