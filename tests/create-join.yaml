description: "develop version of the dataset for a few days and a few variables, once data on mars is cached it should take a few seconds to generate the dataset"
dataset_status: testing
purpose: aifs
name: test-small

common:
  mars_request: &mars_request
    name: mars
    expver: '0001'
    class: ea
    grid: 20./20.
    stream: oper
    type: an
    date: $datetime_format($dates,%Y%m%d)
    time: $datetime_format($dates,%H%M)
  dates: &dates_anchor
    start: 2020-12-30 00:00:00
    end: 2021-01-03 12:00:00
    frequency: 12h

loop:
- dates:
    "<<": *dates_anchor
    group_by: monthly

input:
  dates:
    "<<": *dates_anchor
    join:
    - label:
        name: previous_data
        source:
          '<<': *mars_request
          param: [2t]
          levtype: sfc

    - source:
        '<<': *mars_request
        param: [q, t]
        levtype: pl
        level: [50, 100]

    - source:
        '<<': *mars_request
        name: era5-accumulations
        param: [cp, tp]
        # era5-accumulations requires time in hours
        time: $datetime_format($dates,%H)

    - source:
        name: constants
        param:
        - cos_latitude
        source_or_dataset: $previous_data
        date: $dates

output:
  chunking: {dates: 1}
  dtype: float32
  flatten_grid: True
  order_by:
  - valid_datetime
  - param_level
  - number
  statistics: param_level
  statistics_end: 2021
  remapping: &remapping
    param_level: '{param}_{levelist}'
