description: "develop version of the dataset for a few days and a few variables, once data on mars is cached it should take a few seconds to generate the dataset"
dataset_status: testing
purpose: aifs
name: create-pertubations
config_format_version: 2

common:
  mars_request: &common
    name: mars
    class: ea
    date: $datetime_format($dates,%Y%m%d)
    time: $datetime_format($dates,%H%M)
    expver: '0001'
    grid: 20.0/20.0
    levtype: sfc
    param: [2t]
  dates: &dates_anchor
    start: 2020-12-30 00:00:00
    end: 2021-01-03 12:00:00
    frequency: 12h

loop:
- dates:
    "<<": *dates_anchor
    group_by: monthly

input:
  dates:
    "<<": *dates_anchor
    function:
      name: ensemble_perturbations
      ensembles: # the ensemble data has one additional dimension
        '<<': *common
        stream: enda
        type: an
        number: 0/to/4/by/2
        # number: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

      center: # the new center of the data
        '<<': *common
        stream: oper
        type: an

      mean: # the previous center of the data
        '<<': *common
        stream: enda
        type: em


output:
  chunking: {dates: 1}
  dtype: float32
  flatten_grid: True
  order_by:
  - valid_datetime
  - param_level
  - number
  statistics: param_level
  statistics_end: 2021
  remapping:
    param_level: '{param}_{levelist}'
